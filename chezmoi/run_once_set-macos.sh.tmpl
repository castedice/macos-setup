#!/bin/bash
echo "⚙️  macOS 기본값 적용 (서버 모드: {{ .headless }})"

# --- 공통 설정 ---
# Finder: 확장자 모두 보기, 경로/상태 막대 보기
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder ShowStatusBar -bool true
# Finder: 숨김 파일, 폴더 우선, 확장자 경고 비활성화, 검색 범위
defaults write com.apple.finder AppleShowAllFiles -bool true
defaults write com.apple.finder _FXSortFoldersFirst -bool true
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true
defaults write com.apple.finder ShowRecentTags -bool false
# Finder: 기본 보기, 퀵룩 텍스트 선택
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
defaults write com.apple.finder QLEnableTextSelection -bool true
# 스크롤바 항상 표시
defaults write NSGlobalDomain AppleShowScrollBars -string "Always"
# 저장/인쇄 패널 확장
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true
# 새 문서 기본 저장 위치 (iCloud 비활성화)
defaults write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false
# 스마트 입력 비활성화 (코드 작성용)
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticTextCompletionEnabled -bool false
# 키 반복
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 15
# 스크린샷
mkdir -p "$HOME/Screenshots"
defaults write com.apple.screencapture location -string "$HOME/Screenshots"
defaults write com.apple.screencapture type -string "png"
defaults write com.apple.screencapture disable-shadow -bool true
# Dock: 최근 앱 숨기기, 앱별 최소화
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock minimize-to-application -bool true
defaults write com.apple.dock mru-spaces -bool false
# .DS_Store 생성 방지
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# 숨겨진 Library 폴더 표시
chflags nohidden "$HOME/Library"

# --- 헤드리스 서버 전용 설정 ---
{{- if .headless }}
echo "   >> [서버] 잠자기 및 스크린세이버 비활성화"
# 1. 잠자기 방지 (전원 연결 시)
sudo pmset -a sleep 0
sudo pmset -a displaysleep 0
sudo pmset -a autorestart 1

# 2. 스크린세이버 끄기
defaults -currentHost write com.apple.screensaver idleTime -int 0

# 3. Dock 숨기기 (VNC 화면 확보)
defaults write com.apple.dock autohide -bool true
{{- else }}
# --- 일반 맥북 설정 ---
echo "   >> [데스크탑] 기본 전원 관리 사용"
sudo pmset -a sleep 15
defaults write com.apple.dock autohide -bool false
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
{{- end }}

# UI 재시작
killall Finder >/dev/null 2>&1 || true
killall Dock >/dev/null 2>&1 || true
killall SystemUIServer >/dev/null 2>&1 || true
